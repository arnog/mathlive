<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>MathLive Testing Playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../style.css" />
    <style>
      .mathfield {
        font-size: 32px;
      }

      math-field:not(:defined) {
        display: none;
      }

      /* math-field:focus-within {
      outline: none;
      background: red;
    } */

      code {
        white-space: pre-wrap;
      }

      h2 {
        font-size: 1em;
        padding: 0;
        margin: 0;
        color: #666;
      }

      #mathfield-container {
        padding: 8px;
        min-width: 50px;
        border: 1px solid #ddd;
      }

      #ta {
        font-size: 1.5em;
        font-weight: 700;
      }

      #find-input,
      #replace-input {
        width: 320px;
      }

      .hidden {
        display: none;
      }

      .label {
        font-weight: 700;
      }

      .math {
        display: none;
      }

      /* .buttonbar button { */
      button {
        background: none;
        border: 1px solid rgba(0, 0, 0, 0.12);
        border-radius: 4px;
        color: #0066ce;
        fill: currentColor;
        position: relative;
        height: 36px;
        line-height: 36px;
        margin: 0 18px 0 0;
        min-width: 64px;
        padding: 0 16px;
        display: inline-block;
        overflow: hidden;
        will-change: box-shadow;
        transition: box-shadow 0.2s cubic-bezier(0.4, 0, 1, 1),
          background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
          color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        vertical-align: middle;
        -webkit-user-select: none;
        user-select: none;

        font-size: 16px;
        letter-spacing: 0.08929em;
        text-transform: uppercase;
        box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.2),
          0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 3px 1px -2px rgba(0, 0, 0, 0.12);
      }

      button:first-child {
        margin-left: 0;
      }

      button:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }

      button:active {
        background-color: white;
      }

      button.primary,
      button.active {
        color: white;
        fill: currentColor;
        background: #0066ce;
      }

      button.primary:hover {
        background-color: rgba(0, 102, 206, 0.58);
      }

      button.primary:active {
        color: #0066ce;
        fill: currentColor;
        background-color: white;
      }

      button.round {
        width: 64px;
        height: 64px;
        border-radius: 50%;
      }

      .buttonbar {
        margin-top: 1em;
      }

      #keyboard-container {
        display: block;
        position: relative;

        height: 600px;
        width: 1024px;
        background: palegreen;
        overflow: hidden;
        border: 5px solid red;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>MathLive Testing Playground</h1>
    </header>
    <main class="centered" tabindex="0">
      <!-- <div id='keyboard-container'> -->
      <math-field
        id="mf"
        class="mathfield"
        style="font-size: 32px; max-width: 640px; width: 100%"
        virtual-keyboard-mode="manual"
      >
        <!-- \begin{bmatrix}
        {\placeholder{}} &{\placeholder{}}   \\
        {\placeholder{}} &{\placeholder{}}   \\
        {\placeholder{}} &{\placeholder{}}   
      \end{bmatrix} -->
        <!-- x=\frac{-b\pm\sqrt{b^2-4ac}}{2a} -->
        <!-- \smolfrac{1}{2} -->
        <!-- f^{\prime\prime}(x) -->
        <!-- x=\frac{{-b\pm\sqrt{b^2-4ac}}}{{2a}} -->
        <!-- -0-0=-0(0) -->
      </math-field>
      <!-- </div> -->
      <!-- <button id='toggle-fullscreen'>Toggle fullscreen</button> -->

      <!-- \textcolor{blue}{\sqrt{\smash[t]{\frac{a}{b}}}=\sqrt{\smash[b]{\frac{a}{b}}}} -->

      <!-- \textcolor{blue}{\overset{=}{x}} -->

      <!-- \textcolor{blue}{\overline{x}=\overline{x+\frac34}=\underline{x}=\underline{x+\frac34}} -->

      <!-- \textcolor{blue}{\vec{x}=\vec{\frac34}=\widehat{x}=\widehat{x+y}} -->

      <!-- \textcolor{blue}{\int_0^\infty\smallint_0^\infty\oint_0^\infty} -->

      <!-- \textcolor{blue}{\Large \frac34=\frac{3}{x+1}=\binom34=\sqrt{2}=\sqrt[3]{2}} -->

      <!-- \textcolor{blue}{\Large \sqrt{2}=\sqrt[3]{2}} -->

      <!-- \textcolor{blue}{x=\sqrt[3]{x}=\frac{x^2}{x^2}=\left(\frac34\right)=\int_0^\infty} -->
      <!-- -a-b=-1 -->

      <!--30\operatorname{cm}^2+4\operatorname{mm}^2-->
      <!--f(x)=\frac{x+1}{x-1}+x+1 -->
      <!--x=\begin{bmatrix}x+1&b&c\\\alpha&\\beta\end{bmatrix}^T+x+1 -->
      <!--  $$x+\left(\sqrt{x+1}+1\right)+\sum_0^4n^2+\frac{1+x}{x-1}\int^{\infty}_0x\mathrm{d}x+\boxed{\frac{1}{x}}\colorbox{yellow}{\sqrt{\frac{1}{x}}}\cancel{x^2+1}\xRightarrow[\text{above}]{\text{below}}$$
            -->
      <!-- x=x^2_{b+1}+\frac{1}{2_{56}}^{34}_{56}+\sqrt{23}+\sqrt[45]{67}+\box{x+1}+\xRightarrow[below]{above}^2+\begin{matrix}1&2&3\\4\\5&6\end{matrix} -->
      <!-- (x,,2) -->
      <!-- -123, 456.789, -->
      <!-- x_5 -->
      <!-- -5-3-2 -->
      <!-- 12+ -->
      <!-- \lbrack\rbrack -->
      <!-- \foo  -->
      <!-- (a,,b) -->
      <!--       a\le b \overline{z} \overrightarrow{ABC} -->
      <!-- $$(deadbeef)_{16}$$ -->
      <!-- \partial^2_{x,y} f(x,y) -->
      <!-- |(a+|b|+1)| -->
      <!-- -0+0(\frac{0}{\frac{0}{0}}-0)+x^\pi -->
      <!-- -0+0(\frac{0}{\frac{0}{0}}-0) -->
      <!-- x_0 + x_{0} +  x_n + x_{n+1}-->
      <!-- -2x5z\sqrt{y}\frac{3}{4}3\pi y} -->
      <!-- \sin^{-1}\prime(x)      \sin^{-1}'(x) -->
      <!-- "\begin{align*}\dot{x} & =\sigma(y-x) \\ \dot{y} & =\rho x-y-xz \\ \dot{z} & =-\beta z+xy\end{align*}" -->
      <!-- i, 2i, -i -->
      <!-- 2{xy} should create group -->

      <!-- \binom12 \textstyle \binom34 \scriptstyle \binom56 \displaystyle \binom78 \scriptstyle \binom90 -->
      <!-- \int^b_a x^2 dx -->
      <!-- \int^b_a\int^c_d x^2 dx dy -->
      <!-- \int x^2 + x = 0 -->
      <!-- \int x^2 + x dx = 0 -->
      <!-- \int (x^2 + x) dx = 0 -->

      <div class="centered">
        <input id="find-input" placeholder="Find Latex" /><input />
      </div>
      <div class="centered" style="margin-top: 0.5em">
        <input id="replace-input" placeholder="Replace With..." /><input />
      </div>

      <div id="search-results" class="centered">
        <h2 style="margin-top: 1em">Search Results</h2>
        <div class="output" id="search-results-output"></div>
      </div>

      <h2 style="margin-top: 1em">Selection</h2>
      <div class="output" id="selection"></div>

      <h2>Latex</h2>
      <div class="output" id="latex"></div>
      <h2>MathASCII</h2>
      <div class="output" id="mathascii"></div>
      <h2>MathML</h2>
      <div class="output" id="mathml"></div>
      <h2>MathJSON</h2>
      <div class="output" id="math-json"></div>
    </main>

    <script type="module">
      import {
        convertLatexToMarkup,
        renderMathInDocument,
      } from '/dist/mathlive.mjs';
      renderMathInDocument({
        renderAccessibleContent: false,
        // TeX: {
        //   delimiters: { inline: display: [ ['$$', '$$'] ] },
        //   processEnvironments : false
        // },
        asciiMath: null,
      });

      let gSearchLatex;

      function applySearchTerm() {
        if (!gSearchLatex) {
          document.getElementById('search-results').classList.add('hidden');
          return;
        }
        document.getElementById('search-results').classList.remove('hidden');
        const mf = document.getElementById('mf');

        mf.applyStyle(
          { color: 'none', backgroundColor: 'none' },
          {
            range: [0, -1],
            suppressChangeNotifications: true,
          }
        );

        const searchResults = mf.find(
          gSearchLatex.startsWith('/')
            ? new RegExp(gSearchLatex.slice(1, -1))
            : gSearchLatex
        );

        document.getElementById('search-results-output').innerHTML =
          searchResults
            .map(
              (range) => `${range[0]}, ${range[1]} = "${mf.getValue(range)}"`
            )
            .join('<br>');
        searchResults.forEach((x) =>
          mf.applyStyle({ color: 'red', backgroundColor: 'yellow' }, x, {
            suppressChangeNotifications: true,
          })
        );
      }
      function applyReplace() {
        document.getElementById('search-results').classList.add('hidden');
        if (!gSearchLatex) {
          return;
        }

        const mf = document.getElementById('mf');

        mf.applyStyle(
          { color: 'none', backgroundColor: 'none' },
          {
            range: [0, -1],
            suppressChangeNotifications: true,
          }
        );
        const replacement = replaceInput.value;
        const searchResults = mf.replace(
          gSearchLatex.startsWith('/')
            ? new RegExp(gSearchLatex.slice(1, -1))
            : gSearchLatex,
          replacement /* (args) => {
                  console.log(args);
                  return replacement;
              }*/
        );
      }

      const ta = document.getElementById('find-input');
      ta.addEventListener('change', (ev) => {
        gSearchLatex = ta.value;
        applySearchTerm();
      });

      const replaceInput = document.getElementById('replace-input');
      replaceInput.addEventListener('change', (ev) => {
        applyReplace();
      });

      // const container = document.getElementById('keyboard-container')
      // document.getElementById('toggle-fullscreen')
      //   .addEventListener('click', () => container.requestFullscreen())

      const mf = document.getElementById('mf');

      mf.setOptions({
        virtualKeyboardMode: 'manual',
        virtualKeyboardToggleGlyph: `<span style="width: 21px;"><svg style="width: 21px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M192 288H32c-18 0-32 14-32 32v160c0 18 14 32 32 32h160c18 0 32-14 32-32V320c0-18-14-32-32-32zm-29 140c3 3 3 8 0 12l-11 11c-4 3-9 3-12 0l-28-28-28 28c-3 3-8 3-12 0l-11-11c-3-4-3-9 0-12l28-28-28-28c-3-3-3-8 0-12l11-11c4-3 9-3 12 0l28 28 28-28c3-3 8-3 12 0l11 11c3 4 3 9 0 12l-28 28 28 28zM480 0H320c-18 0-32 14-32 32v160c0 18 14 32 32 32h160c18 0 32-14 32-32V32c0-18-14-32-32-32zm-16 120c0 4-4 8-8 8h-40v40c0 4-4 8-8 8h-16c-4 0-8-4-8-8v-40h-40c-4 0-8-4-8-8v-16c0-4 4-8 8-8h40V56c0-4 4-8 8-8h16c4 0 8 4 8 8v40h40c4 0 8 4 8 8v16zm16 168H320c-18 0-32 14-32 32v160c0 18 14 32 32 32h160c18 0 32-14 32-32V320c0-18-14-32-32-32zm-16 152c0 4-4 8-8 8H344c-4 0-8-4-8-8v-16c0-4 4-8 8-8h112c4 0 8 4 8 8v16zm0-64c0 4-4 8-8 8H344c-4 0-8-4-8-8v-16c0-4 4-8 8-8h112c4 0 8 4 8 8v16zM192 0H32C14 0 0 14 0 32v160c0 18 14 32 32 32h160c18 0 32-14 32-32V32c0-18-14-32-32-32zm-16 120c0 4-4 8-8 8H56c-4 0-8-4-8-8v-16c0-4 4-8 8-8h112c4 0 8 4 8 8v16z"/></svg></span>`,
        smartFence: true,
        macros: {
          ...mf.getOptions('macros'),
          smolfrac: '{}^{#1}\\!\\!/\\!{}_{#2}',
        },
        onExport: (mf, latex, range) => {
          console.log(latex);
          return `$${mf.getValue(range, 'latex-expanded')}$`;
        },
        // virtualKeyboardContainer: document.getElementById('keyboard-container')
      });

      mf.addEventListener('virtual-keyboard-toggle', () => {
        // Doesn't fire
        console.log('Virtual keyboard toggled');
      });

      // Example of Alt-Keys
      //     const VIRTUAL_KEYBOARD_LAYERS = {
      //       "secondary-layer": {
      //         rows: [
      //           [
      //             { class: "tex", label: "x", key: "x", insert: "y",
      //               variants: [    'y',
      //     'z',
      //     't',
      //     'r',
      //     { latex: 'f(#?)', class: 'small' },
      //     { latex: 'g(#?)', class: 'small' },
      //     'x^2',
      //     'x^n',
      //     'x_n',
      //     'x_{n+1}',
      //     'x_i',
      //     'x_{i+1}',
      // ]
      //             },
      //           ],
      //         ]
      //       }
      //     }

      const VIRTUAL_KEYBOARD_LAYERS = {
        'secondary-layer': {
          rows: [
            [
              {
                label: '&#x21e7;',
                class: 'shift modifier font-glyph bottom left w15 layer-switch',
                layer: 'geometry-layer',
              },
              {
                class: 'tex',
                label: 'x',
                key: 'x',
                insert: 'y',
                altKeys: [
                  { class: 'w15', latex: '\\cos\\mleft( #0 \\mright)' },
                ],
              },
              // { class: "w15", latex: "\\sin\\mleft( #0 \\mright)" },
              { class: 'w15', label: 'cos(x)', shifted: 'sin (x)' },
              { class: 'w15', latex: '\\tan\\mleft( #0 \\mright)' },
              { class: 'separator w5' },
              { latex: '\\land' },
              { latex: '\\lor' },
              { latex: '\\lnot' },
              { class: 'separator w5' },
              { latex: '\\approx' },
            ],
            [
              { class: 'w15', latex: '\\sin^{-1}\\mleft( #0 \\mright)' },
              { class: 'w15', latex: '\\cos^{-1}\\mleft( #0 \\mright)' },
              { class: 'w15', latex: '\\tan^{-1}\\mleft( #0 \\mright)' },
              { class: 'separator w5' },
              { class: 'w15', latex: '#@^{#?}' },
              { class: 'w15', latex: '#@^2' },
              { class: 'separator w5' },
              { latex: '\\cong' },
            ],
            [
              {
                class: 'w15',
                latex: '\\begin{vmatrix}#?&#?\\\\#?&#?\\end{vmatrix}',
              },
              { latex: '\\sqrt{#@}' },
              { latex: '\\pm' },
              { latex: '\\overarc{#@}' },
              { latex: '\\sim' },
              { class: 'w15', latex: '#@_{#?}' },
            ],
            [
              { class: 'separator w20' },
              { class: 'separator w20' },
              { class: 'separator w20' },
              { class: 'separator w15' },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-left' /></svg>",
                command: ['performWithFeedback', 'moveToPreviousChar'],
              },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-right' /></svg>",
                command: ['performWithFeedback', 'moveToNextChar'],
              },
            ],
          ],
        },
        'geometry-layer': {
          rows: [
            [
              // <ul><li class='shift modifier font-glyph bottom left selected w15 layer-switch' data-layer='lower-greek'>&#x21e7;</li>

              { latex: '\\vert' },
              { latex: '\\not{\\vert}' },
              { latex: '\\parallel' },
              { latex: '\\bot' },
              { latex: '\\overrightarrow{#@}' },
              { latex: '\\begin{pmatrix}#0\\\\#0\\end{pmatrix}' },
            ],
            [
              { latex: '\\measuredangle' },
              { latex: ';' },
              { latex: '\\longmapsto' },
              { latex: '\\left\\lvert #0 \\right\\rvert' },
              { latex: '\\left\\lvert \\overline{#0} \\right\\rvert' },
              { latex: '\\overline{#@}' },
            ],
            [],
            [
              { class: 'separator w20' },
              { class: 'separator w20' },
              { class: 'separator w20' },
              { class: 'separator w15' },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-left' /></svg>",
                command: ['performWithFeedback', 'moveToPreviousChar'],
              },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-right' /></svg>",
                command: ['performWithFeedback', 'moveToNextChar'],
              },
            ],
          ],
        },
        'basic-layer': {
          styles: '',
          rows: [
            [
              {
                label: '7',
                key: '7',
                variants: ['\\alpha', '\\beta'],
              },
              { label: '8', key: '8' },
              { label: '9', key: '9' },
              { label: '+', key: '+' },
              { class: 'separator w5' },
              { class: 'small', latex: '\\frac{#0}{#0}' },
              { latex: '\\varnothing' },
              { latex: '\\infty' },
              { latex: '\\in' },
              { latex: '\\notin' },
              { class: 'separator w10' },
            ],
            [
              { label: '4', latex: '4' },
              { label: '5', key: '5' },
              { label: '6', key: '6' },
              { label: '-', key: '-' },
              { class: 'separator w5' },
              { label: '(', key: '(' },
              { label: ')', key: ')' },
              { latex: '\\lt' },
              { latex: '\\le' },
              { latex: '\\hat{=}' },
              { class: 'separator w10' },
            ],
            [
              { label: '1', key: '1' },
              { label: '2', key: '2' },
              { label: '3', key: '3' },
              { latex: '\\cdot' },
              { class: 'separator w5' },
              { label: '[', key: '[' },
              { label: ']', key: ']' },
              { latex: '\\gt' },
              { latex: '\\ge' },
              { class: 'separator w10' },
              {
                class: 'action font-glyph bottom right',
                label: '&#x232b;',
                command: ['performWithFeedback', 'deleteBackward'],
              },
            ],
            [
              { class: 'w20', label: '0', key: '0' },
              { latex: ',' },
              { latex: '\\colon' },
              { class: 'separator w5' },
              { latex: '\\lbrace' },
              { latex: '\\rbrace' },
              { latex: '=' },
              { latex: '\\ne' },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-left' /></svg>",
                command: ['performWithFeedback', 'moveToPreviousChar'],
              },
              {
                class: 'action',
                label: "<svg><use xlink:href='#svg-arrow-right' /></svg>",
                command: ['performWithFeedback', 'moveToNextChar'],
              },
            ],
          ],
        },
      };

      const KEYBOARDS = {
        basic: {
          label: 'Basic',
          tooltip: 'Basic',
          layer: 'basic-layer',
        },
        // "geometry": {
        //   "label": "Geometry",
        //   "tooltip": "Geometry",
        //   "layer": "geometry-layer"
        // },
        secondary: {
          label: 'Secondary',
          tooltip: 'Secondary',
          layer: 'secondary-layer',
          layers: ['secondary-layer', 'geometry-layer'],
        },
      };

      mf?.setOptions({
        // inlineShortcuts: {
        //   in: {
        //     mode: 'math',
        //     after: 'space+letter+digit+symbol+fence',
        //     value: '\\in',
        //   },
        // },
        customVirtualKeyboardLayers: VIRTUAL_KEYBOARD_LAYERS,
        customVirtualKeyboards: KEYBOARDS,
        virtualKeyboards: 'basic secondary',
        // "virtualKeyboards": "basic greek secondary geometry",
        // onBlur: () => { console.log('blurring') },
        // onKeystroke: (mf, keystroke, ev) => {
        //   if (keystroke === 'alt+[KeyS]') {
        //     mf.insert('\\sum^\\infty_{n=0}');
        //     return false; // Stop propagation
        //   } else if (keystroke === 'meta+[KeyK]') {
        //     mf.executeCommand('toggleVirtualKeyboard');
        //     return false;
        //   }
        //   console.log('options keystroke', keystroke);
        //   return true;
        // },
        // inlineShortcuts: {
        //     // ㄱ: '\\sqrt',
        //     sq: '\\sqrt{#0}',
        //     // ㄱㄴ: '\\sqrt{#0}',
        //     "ㄱㄴ": '\\sqrt{#0}',
        // },
        // macros: {
        // },
        onError: (ev) => {
          console.log('Error :' + ev.code);
        },
      });

      mf?.addEventListener('click', (ev) => {
        console.log('something was clicked');
      });
      mf?.addEventListener('input', (ev) => {
        updateContent(mf);
        applySearchTerm();
      });
      mf?.addEventListener('focus-out', (ev) => {
        console.log(ev.detail);
      });
      mf?.addEventListener('move-out', (ev) => {
        console.log(ev.detail);
      });

      // mf.addEventListener('change', (ev) => {
      // });
      mf?.addEventListener('selection-change', (ev) => {
        const selection = mf.selection;
        // console.assert(selection.ranges[0][0] !== 2 || selection.ranges[0][1] !== 3);
        document.getElementById('selection').innerHTML =
          // label("anchor    ") + mf.anchor + "<br>" +
          label('position  ') +
          mf.position +
          '<br>' +
          label('start     ') +
          selection.ranges[0][0] +
          '<br>' +
          label('end       ') +
          selection.ranges[0][1] +
          '<br>' +
          label('direction ') +
          '"' +
          selection.direction +
          '"<br>' +
          label('value     ') +
          '"' +
          mf.getValue(selection) +
          '"<br>' +
          label('depth     ') +
          mf.getOffsetDepth(mf.position);
      });
      mf?.addEventListener('math-error', (ev) => {
        console.log('Error :' + ev.detail.code);
      });
      if (mf) {
        updateContent(mf);
        applySearchTerm();
      }

      function updateContent(mf) {
        const latex = mf.getValue('latex-expanded');
        try {
          document.getElementById('latex').innerHTML = escapeHtml(latex);

          document.getElementById('mathascii').innerHTML = escapeHtml(
            mf.getValue('ascii-math')
          );
          document.getElementById('mathml').innerHTML = escapeHtml(
            mf.getValue('math-ml')
          );
          document.getElementById('math-json').innerHTML = escapeHtml(
            mf.getValue('math-json')
          );
        } catch (e) {
          console.error(
            'Error converting %c ' + latex + '%c ' + e.toString(),
            'color: red;  background: hsla(0, 60%, 90%)',
            'background: transparent'
          );
        }
      }

      function label(s) {
        return `<span class='label'>${s}</span>`;
      }

      function escapeHtml(string) {
        return String(string).replace(/[&<>"'`= /\u200b]/g, function (s) {
          return (
            {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;',
              '/': '&#x2F;',
              '`': '&#x60;',
              '=': '&#x3D;',
              '\u200b': '&amp;#zws;',
            }[s] || s
          );
        });
      }
    </script>
  </body>
</html>
